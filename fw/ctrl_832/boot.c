// boot.c
// bootscreen functions
// 2014, rok.krajnc@gmail.com

#include "errors.h"
#include "string.h"
#include "stdio.h"
#include "boot.h"
#include "hardware.h"
#include "osd.h"
#include "fpga.h"
#include "spi.h"
#include "fat.h"
#include "rafile.h"


static unsigned char *bootscreen_adr; // = 0x80000 + /*120*/112*640/8;

void BootHome() {
  bootscreen_adr = (unsigned char *)((0x80000 + 112*640/8)^0xd80000);
}

//// boot font ////
static const char boot_font [96][8] = {
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // SPACE
  {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},  // !
  {0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // "
  {0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00},  // #
  {0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00},  // $
  {0x00, 0x66, 0xAC, 0xD8, 0x36, 0x6A, 0xCC, 0x00},  // %
  {0x38, 0x6C, 0x68, 0x76, 0xDC, 0xCE, 0x7B, 0x00},  // &
  {0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},  // '
  {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},  // (
  {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},  // )
  {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},  // *
  {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},  // +
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},  // ,
  {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},  // -
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},  // .
  {0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00},  // /
  {0x3C, 0x66, 0x6E, 0x7E, 0x76, 0x66, 0x3C, 0x00},  // 0
  {0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x18, 0x00},  // 1
  {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x00},  // 2
  {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00},  // 3
  {0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x00},  // 4
  {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00},  // 5
  {0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00},  // 6
  {0x7E, 0x06, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x00},  // 7
  {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00},  // 8
  {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00},  // 9
  {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},  // :
  {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},  // ;
  {0x00, 0x06, 0x18, 0x60, 0x18, 0x06, 0x00, 0x00},  // <
  {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},  // =
  {0x00, 0x60, 0x18, 0x06, 0x18, 0x60, 0x00, 0x00},  // >
  {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00},  // ?
  {0x7C, 0xC6, 0xDE, 0xD6, 0xDE, 0xC0, 0x78, 0x00},  // @
  {0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},  // A
  {0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00},  // B
  {0x1E, 0x30, 0x60, 0x60, 0x60, 0x30, 0x1E, 0x00},  // C
  {0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00},  // D
  {0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00},  // E
  {0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00},  // F
  {0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3E, 0x00},  // G
  {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},  // H
  {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},  // I
  {0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00},  // J
  {0xC6, 0xCC, 0xD8, 0xF0, 0xD8, 0xCC, 0xC6, 0x00},  // K
  {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00},  // L
  {0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00},  // M
  {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00},  // N
  {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},  // O
  {0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00},  // P
  {0x78, 0xCC, 0xCC, 0xCC, 0xCC, 0xDC, 0x7E, 0x00},  // Q
  {0x7C, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0x00},  // R
  {0x3C, 0x66, 0x70, 0x3C, 0x0E, 0x66, 0x3C, 0x00},  // S
  {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},  // T
  {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},  // U
  {0x66, 0x66, 0x66, 0x66, 0x3C, 0x3C, 0x18, 0x00},  // V
  {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00},  // W
  {0xC3, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0xC3, 0x00},  // X
  {0xC3, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x00},  // Y
  {0xFE, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0xFE, 0x00},  // Z
  {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},  // [
  {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x00},  // Backslash
  {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},  // ]
  {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},  // ^
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE},  // _
  {0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},  // `
  {0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00},  // a
  {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00},  // b
  {0x00, 0x00, 0x3C, 0x60, 0x60, 0x60, 0x3C, 0x00},  // c
  {0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00},  // d
  {0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00},  // e
  {0x1C, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x00},  // f
  {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x3C},  // g
  {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},  // h
  {0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00},  // i
  {0x0C, 0x00, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x78},  // j
  {0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00},  // k
  {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00},  // l
  {0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xC6, 0xC6, 0x00},  // m
  {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},  // n
  {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00},  // o
  {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60},  // p
  {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06},  // q
  {0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00},  // r
  {0x00, 0x00, 0x3C, 0x60, 0x3C, 0x06, 0x7C, 0x00},  // s
  {0x30, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x1C, 0x00},  // t
  {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00},  // u
  {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},  // v
  {0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xFE, 0x6C, 0x00},  // w
  {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00},  // x
  {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x30},  // y
  {0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00},  // z
  {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},  // {
  {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},  // |
  {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},  // }
  {0x72, 0x9C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},  // ~
  {0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0x00}   //
};


//// BootClearScreen() ////
void BootClearScreen(unsigned short *adr, int size)
{
	int i;
	adr=(unsigned short *)(((int)adr & 0x7fffff) ^ 0xd80000);
	for (i=0; i<size; i++) {
		*adr++=0;
	}
}


//// BootUploadLogo() ////
void BootUploadLogo()
{
	RAFile file;
	int x,y;
	int i=0;
	unsigned char *adr;

	if (RAOpen(&file, LOGO_FILE)) {
		RARead(&file, sector_buffer, 512);
		for (y=0; y<LOGO_HEIGHT; y++) {
			adr = (unsigned char *)((SCREEN_BPL1+LOGO_OFFSET+y*(SCREEN_WIDTH/8))^0xd80000);
			for (x=0; x<LOGO_WIDTH/16; x++) {
				if (i == 512) {
					RARead(&file, sector_buffer, 512);
					i = 0;
				}
				*adr++=sector_buffer[i++];
				*adr++=sector_buffer[i++];
			}
		}
		for (y=0; y<LOGO_HEIGHT; y++) {
			adr = (unsigned char *)((SCREEN_BPL2+LOGO_OFFSET+y*(SCREEN_WIDTH/8))^0xd80000);
			for (x=0; x<LOGO_WIDTH/16; x++) {
				if (i == 512) {
					RARead(&file, sector_buffer, 512);
					i = 0;
				}
				*adr++=sector_buffer[i++];
				*adr++=sector_buffer[i++];
			}
		}
	}
  ClearError(ERROR_FILESYSTEM);
}


//// BootUploadBall() ////
void BootUploadBall()
{
	RAFile file;
	int x;
	int i=0;
	unsigned char *adr;

	if (RAOpen(&file, BALL_FILE)) {
		adr = (unsigned char *)(BALL_ADDRESS ^ 0xd80000);
		RARead(&file, adr, BALL_SIZE);
	}
	ClearError(ERROR_FILESYSTEM);
}


//// BootUploadCopper() ////
void BootUploadCopper()
{
	RAFile file;
	int x;
	int i=0;
	unsigned char *adr;

	if (RAOpen(&file, COPPER_FILE)) {
		adr = (unsigned char *)(COPPER_ADDRESS ^ 0xd80000);
		RARead(&file, adr, COPPER_SIZE);
	} else {
		unsigned short *p = (unsigned short *)(COPPER_ADDRESS ^ 0xd80000);
		*p++=0x00e0; *p++=0x0008;
		*p++=0x00e2; *p++=0x0000;
		*p++=0x00e4; *p++=0x0008;
		*p++=0x00e6; *p++=0x5000;
		*p++=0x0100; *p++=0xa200;
		*p++=0xffff; *p++=0xfffe;
	}
	ClearError(ERROR_FILESYSTEM);
}

#include "bootcustominit.h"

//// BootCustomInit() ////
void BootCustomInit()
{
	unsigned char *upload=(unsigned char *)(0x780000^0xd80000);
	unsigned char *src=bootcustominit_bin;
	int i=bootcustominit_bin_len;
	while(--i)
		*upload++=*src++;
}


//// BootInit() ////
void BootInit()
{
//  BootEnableMem();
  // TEMP enable 1MB memory
  spi_osd_cmd8(OSD_CMD_MEM, 0x5);
  SPIN; SPIN; SPIN; SPIN;

  // Put the CPU in reset while we upload init data.
  EnableOsd();
  SPI(OSD_CMD_RST);
  SPI(SPI_CPU_HLT | SPI_RST_CPU);
  DisableOsd();

  BootClearScreen(SCREEN_ADDRESS, SCREEN_MEM_SIZE);
  BootUploadLogo();
  BootUploadBall();
  BootUploadCopper();
  BootCustomInit();

  EnableOsd();
  SPI(OSD_CMD_RST);
  SPI(0); // Allow the CPU to run 
  DisableOsd();
}


//// BootPrint() ////
void BootPrintEx(char * str)
{
  char buf[2];
  unsigned char i,j;
  unsigned char len;
  unsigned char *ptr;
  if(!bootscreen_adr)
    BootHome();

  printf(str);
  printf("\n");
  
  len = strlen(str);
  len = (len>80) ? 80 : len;
  
	for(j=0; j<8; j++) {
		ptr=bootscreen_adr;
		for(i=0; i<len; i+=2) {
			*ptr++=boot_font[str[i]-32][j];
			if (i==(len-1))
				*ptr++=boot_font[0][j];
			else
				*ptr++=boot_font[str[i+1]-32][j];
		}
		bootscreen_adr += 640/8;
	}
}

